# This workflow defines the Continuous Deployment (CD) pipeline for the Crop Predictor application.
# It is triggered ONLY upon the successful completion of the CI pipeline on the 'main' branch.
# Its purpose is to deploy the packaged artifact to the AWS EC2 instance.

name: CD Pipeline - Deploy Crop Predictor

# This workflow runs when another workflow ('CI Pipeline - Crop Predictor') has completed.
on:
  workflow_run:
    workflows: ["CI Pipeline - Crop Predictor"] # The name of the CI workflow
    types:
      - completed # The event type that triggers this workflow
    branches:
      - main # Only run for completions on the main branch

jobs:
  # Job to deploy the application to the EC2 instance
  deploy:
    runs-on: ubuntu-latest
    # This condition ensures deployment only runs if the CI workflow was successful
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: crop-predictor-artifact
          # The run_id of the workflow that triggered this run
          run-id: ${{ github.event.workflow_run.id }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Create a directory for the app if it doesn't exist
            mkdir -p ~/crop-predictor-app
            # Copy the contents of the artifact to the app directory on the server
            scp -r * ~/crop-predictor-app/
            # Navigate into the app directory and execute the startup scripts
            cd ~/crop-predictor-app
            ./start_backend.sh
            ./start_frontend.sh
