name: CD Pipeline - Crop Predictor

on:
  workflow_run:
    workflows: ["CI Pipeline - Crop Predictor"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Download artifact from workflow run
        uses: actions/github-script@v7
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "crop-predictor-artifact"
            })[0];
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            let fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/crop-predictor-artifact.zip`, Buffer.from(download.data));

      - name: Unzip and prepare deployment
        run: |
          unzip crop-predictor-artifact.zip
          # Create deployment directory and move files
          mkdir -p deployment
          # Move all extracted files to deployment directory (exclude the zip file itself)
          find . -maxdepth 1 -type f ! -name "crop-predictor-artifact.zip" ! -name "*.yml" ! -name "*.yaml" -exec mv {} deployment/ \;
          find . -maxdepth 1 -type d ! -name "." ! -name "deployment" ! -name ".git*" -exec mv {} deployment/ \;
          ls -la deployment/

      - name: Stop existing applications on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Stop existing processes
            pkill -f "uvicorn app:app" || true
            pkill -f "streamlit run frontend.py" || true

            # Wait for processes to stop
            sleep 5

            # Create deployment directory
            mkdir -p ~/crop-predictor-app
            cd ~/crop-predictor-app
            rm -rf *

      - name: Copy application files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./deployment/*"
          target: "~/crop-predictor-app"
          strip_components: 1

      - name: Install dependencies and setup environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/crop-predictor-app

            # Update system
            sudo apt update

            # Install Python and pip if not exists
            sudo apt install -y python3 python3-pip python3-venv

            # Create virtual environment
            python3 -m venv venv
            source venv/bin/activate

            # Upgrade pip
            pip install --upgrade pip

            # Install dependencies
            if [ -f requirements.txt ]; then
                pip install -r requirements.txt
            else
                echo "requirements.txt not found!"
                exit 1
            fi

            # Create startup scripts
            cat > start_backend.sh << 'EOF'
            #!/bin/bash
            cd ~/crop-predictor-app
            source venv/bin/activate
            export MODEL_PATH="~/crop-predictor-app/model"
            nohup uvicorn app:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &
            echo $! > backend.pid
            EOF

            cat > start_frontend.sh << 'EOF'
            #!/bin/bash
            cd ~/crop-predictor-app
            source venv/bin/activate
            export FASTAPI_URL="http://localhost:8000"
            nohup streamlit run frontend.py --server.port 8501 --server.address 0.0.0.0 --server.headless true > frontend.log 2>&1 &
            echo $! > frontend.pid
            EOF

            cat > stop_services.sh << 'EOF'
            #!/bin/bash
            cd ~/crop-predictor-app
            if [ -f backend.pid ]; then
                kill $(cat backend.pid) 2>/dev/null || true
                rm backend.pid
            fi
            if [ -f frontend.pid ]; then
                kill $(cat frontend.pid) 2>/dev/null || true
                rm frontend.pid
            fi
            pkill -f "uvicorn app:app" || true
            pkill -f "streamlit run frontend.py" || true
            EOF

            # Make scripts executable
            chmod +x start_backend.sh start_frontend.sh stop_services.sh

      - name: Verify deployment structure
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/crop-predictor-app
            echo "Deployment structure:"
            ls -la
            echo "Checking required files:"
            [ -f app.py ] && echo "✓ app.py found" || echo "✗ app.py missing"
            [ -f frontend.py ] && echo "✓ frontend.py found" || echo "✗ frontend.py missing"
            [ -f requirements.txt ] && echo "✓ requirements.txt found" || echo "✗ requirements.txt missing"
            [ -d model ] && echo "✓ model directory found" || echo "✗ model directory missing"
            [ -f model/predict.py ] && echo "✓ model/predict.py found" || echo "✗ model/predict.py missing"

      - name: Start applications
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/crop-predictor-app

            # Stop any existing services
            ./stop_services.sh

            # Wait a moment
            sleep 2

            # Start backend
            echo "Starting backend..."
            ./start_backend.sh

            # Wait for backend to start
            sleep 10

            # Check if backend started successfully
            if [ -f backend.pid ]; then
                if kill -0 $(cat backend.pid) 2>/dev/null; then
                    echo "✓ Backend started successfully"
                else
                    echo "✗ Backend failed to start"
                    cat backend.log
                    exit 1
                fi
            else
                echo "✗ Backend PID file not created"
                cat backend.log
                exit 1
            fi

            # Start frontend
            echo "Starting frontend..."
            ./start_frontend.sh

            # Wait for services to start
            sleep 10

            # Check if frontend started successfully
            if [ -f frontend.pid ]; then
                if kill -0 $(cat frontend.pid) 2>/dev/null; then
                    echo "✓ Frontend started successfully"
                else
                    echo "✗ Frontend failed to start"
                    cat frontend.log
                    exit 1
                fi
            else
                echo "✗ Frontend PID file not created"
                cat frontend.log
                exit 1
            fi

            echo "Both services started successfully!"

      - name: Setup Nginx reverse proxy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Install nginx if not present
            sudo apt install -y nginx

            # Create nginx config
            sudo tee /etc/nginx/sites-available/crop-predictor << 'EOF'
            server {
                listen 80;
                server_name _;
                
                # Streamlit frontend
                location / {
                    proxy_pass http://localhost:8501;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 86400;
                }
                
                # FastAPI backend
                location /api/ {
                    proxy_pass http://localhost:8000/;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            EOF

            # Enable the site
            sudo ln -sf /etc/nginx/sites-available/crop-predictor /etc/nginx/sites-enabled/

            # Remove default site if it exists
            sudo rm -f /etc/nginx/sites-enabled/default

            # Test nginx configuration
            sudo nginx -t

            # Restart nginx
            sudo systemctl restart nginx
            sudo systemctl enable nginx

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Performing health checks..."

            # Check if processes are running
            echo "Checking backend process..."
            if pgrep -f "uvicorn app:app" > /dev/null; then
                echo "✓ Backend process is running"
            else
                echo "✗ Backend process not found"
            fi

            echo "Checking frontend process..."
            if pgrep -f "streamlit run frontend.py" > /dev/null; then
                echo "✓ Frontend process is running"
            else
                echo "✗ Frontend process not found"
            fi

            # Check if ports are listening
            echo "Checking port 8000 (backend)..."
            if netstat -tlnp | grep :8000 > /dev/null; then
                echo "✓ Backend port 8000 is listening"
            else
                echo "✗ Backend port 8000 not listening"
            fi

            echo "Checking port 8501 (frontend)..."
            if netstat -tlnp | grep :8501 > /dev/null; then
                echo "✓ Frontend port 8501 is listening"
            else
                echo "✗ Frontend port 8501 not listening"
            fi

            echo "Checking nginx status..."
            sudo systemctl is-active nginx

            echo "Deployment completed successfully!"
            echo "Access your application at: http://${{ secrets.EC2_HOST }}"
